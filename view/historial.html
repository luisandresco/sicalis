<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitud de citas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
</head>

<body>
    
    <div class="container mt-4 d-none d-sm-block">
        <div class="row">
            <div class="col-4">
                <div class="input-group">
                    <span class="input-group-text">@</span>
                    <input type="text" class="form-control form-control-sm" placeholder="Buscar">
                </div>
            </div>
        </div>
    </div>

    <div class="container bg-white mt-4 rounded-2 shadow d-none d-sm-block">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Paciente</th>
                        <th scope="col">Especialidad</th>
                        <th scope="col">Fecha</th>
                        <th scope="col">Hora</th>
                        <th scope="col">ID</th>
                        <th scope="col">Status</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <nav aria-label="Page navigation example">
                <ul class="pagination">
                    </a>
                  </li>
                </ul>
              </nav>
        </div>
    </div>
  
    <!-- Para pantallas moviles -->

    <div class="container mt-4 d-block d-sm-none d-flex justify-content-center align-items-center">
        <div class="row text-center">
            <div class="">
                <div class="input-group">
                    <span class="input-group-text">@</span>
                    <input type="text" class="form-control form-control-sm" placeholder="Buscar">
                </div>
            </div>
        </div>
    </div>

    <div class="container  d-block d-sm-none juan ">
        <div class="row">
            <div class="table-responsive offset-1 col-11">
                <table class="table table-striped table-hover bg-white mt-4  rounded-2 shadow">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col" class="hola3">Paciente</th>
                            <th scope="col" class="hola4">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th scope="row">1</th>
                            <td class="hola1">JUAN MANUEL</td>
                            <td>
                                <select class="form-select hola">
                                    <option value="confirmado">Confirmado</option>
                                    <option value="cancelado">Cancelado</option>
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </div>

    
    <nav id="menu" class="nav">
        <ul>
            <li><a href="#">
                    <i class="fa-solid fa-bars" onclick="ocultarMenu()"></i>
                </a>
            </li>
            <li><a href="Sicalis-login-registered-HOME-patient-confirmed">
                    <i class=" fas fa-home"></i>
                    <span class="nav-item">Inicio</span>
                </a></li>
            <li><a href="/Sicalis-register-Appointment_confirmation_status_patient">
                    <i class="fas fa-calendar-check"></i>
                    <span class="nav-item">Solicitar citas</span>
                </a></li>
            <!-- <li><a href="#">
                    <i class="fas fa-solid fa-calendar-days"></i>
                    <span class="nav-item">Estado de cita</span>
                </a></li>
            <li><a href="#">
                    <i class="fa-solid fa-notes-medical"></i>
                    <span class="nav-item">Historial </span>
                </a></li>
            <li><a href="#">
                    <i class="fas fa-cog"></i>
                    <span class="nav-item">Configuración</span>
                </a></li> -->
            <li><a href="/Sicalis-login-user-history">
                    <i class="fas fa-notes-medical"></i>
                    <span class="nav-item">Historial</span>
                </a></li>
            <li><a href="Sicalis-exit-session" class="logout" onclick="salir()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="nav-item">Salir</span>
                </a></li>
        </ul>
    </nav>
    <body>
    <script>
        window.onload = function() {
            loadHistory()
        };
        function loadHistory(page){
        var miValor = sessionStorage.getItem('miClave') === 'true';
            // Usar el valor en una declaración if/else
            if (miValor) {
                console.log('Sesión activa');
            } else {
                localStorage.clear()
                window.location.href = "Sicalis-login";
            }
            const showed = localStorage.getItem("cedula");
            const request = new XMLHttpRequest();
            request.onload = function() {
                const response = JSON.parse(request.response);
                const appointments = response.appointments;
                const pagination = response.pagination;
        
                const tbody = document.querySelector('tbody');
                const paginationContainer = document.querySelector('.pagination');
        
                // Limpia el contenido actual del tbody y la paginación
                tbody.innerHTML = '';
  
                // Itera sobre los datos de las citas y crea una nueva fila para cada cita
                appointments.forEach(function(appointment, index) {
                  var row = document.createElement('tr');
                  // Añade las celdas a la fila
                  row.innerHTML = `
                    <th scope="row">${index + 1}</th>
                    <td>${appointment.Nombre} ${appointment.Apellido}</td>
                    <td>${appointment.Especialidad}</td>
                    <td>${appointment.Fecha}</td>
                    <td>${appointment.Hora}</td>
                    <td>${appointment.idcita}</td>
                    <td>
                      ${
                        appointment.Estatus === "Confirmado" || appointment.Estatus === "Registrado"
                          ?
                          `
                          <select class="form-select" onchange="handleStatusChange(event)">
                            <option value=${appointment.Estatus}>${appointment.Estatus}</option>
                            <option value="cancelado">Cancelado</option>
                          </select>
                          `
                          :
                          `<span>${appointment.Estatus}</span>`
                      }
                    </td>
                  `;
                  tbody.appendChild(row);
                });
                
                function handleStatusChange(event) {
                  const select = event.target;
                  const value = select.value;
                  if (value === "cancelado") {
                    const row = select.closest('tr');
                    const idcita = row.querySelector('td:nth-of-type(6)').textContent;
                    handleCancelAppointment(idcita);
                    select.value = "Cancelado por el usuario";
                    select.setAttribute("disabled", true);
                  }
                }
                renderPagination(pagination); // Llama a la función para generar los enlaces de paginación

            };
        
            request.open('POST', '/load_history');
            request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded;charset=UTF-8');
    
            // Envía el token y la cédula en el cuerpo de la solicitud HTTP
            request.send('cedula=' + encodeURIComponent(showed) + '&page=' + encodeURIComponent(page));
        }
        function handleCancelAppointment(idcita) {
          const request = new XMLHttpRequest();
          request.onload = function() {
            // Aquí puedes agregar el código para manejar la respuesta de la solicitud HTTP
          };
          request.open('POST', '/cancel_appointment');
          request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded;charset=UTF-8');
          request.send('idcita=' + encodeURIComponent(idcita));
        }
        
        function renderPagination(pagination) {
            const paginationList = document.querySelector('.pagination');
            paginationList.innerHTML = ''; // Limpia el contenido actual de la paginación
          
            const maxPagesToShow = 2; // Máximo número de páginas para mostrar antes / después de la página actual
          
            const prevLink = document.createElement('a');
            prevLink.classList.add('page-link');
            prevLink.setAttribute('href', '#');
            prevLink.setAttribute('aria-label', 'Previous');
            prevLink.innerHTML = '<span aria-hidden="true">&laquo;</span>';
            prevLink.value = pagination.current_page - 1;
            prevLink.addEventListener('click', function() {
              sendPageRequest(prevLink.value);
            });
          
            const prevListItem = document.createElement('li');
            prevListItem.classList.add('page-item');
            prevListItem.appendChild(prevLink);
            
            paginationList.appendChild(prevListItem);
          
            // Generar los enlaces de página dentro del rango deseado
            for (let i = 1; i <= pagination.total_pages; i++) {
              if (i === 1 || i === pagination.total_pages || Math.abs(i - pagination.current_page) <= maxPagesToShow) {
                const pageLink = document.createElement('a');
                pageLink.classList.add('page-link');
                pageLink.setAttribute('href', '#');
                pageLink.textContent = i;
                pageLink.value = i;
                pageLink.addEventListener('click', function() {
                  sendPageRequest(pageLink.value);
                });
            
                const pageListItem = document.createElement('li');
                pageListItem.classList.add('page-item');
                if (i === pagination.current_page) {
                  pageListItem.classList.add('active');
                }
                pageListItem.appendChild(pageLink);
                
                paginationList.appendChild(pageListItem);
              } else if (paginationList.children.length > 2) {
                // Agregar puntos suspensivos si hay páginas ocultas entre la primera página y el rango deseado
                if (i === 2 && paginationList.children[2].children[0].value - 1 !== 1) {
                  const ellipsis = document.createElement('li');
                  ellipsis.classList.add('page-item', 'disabled');
                  ellipsis.innerHTML = '<span>...</span>';
            
                  paginationList.insertBefore(ellipsis, paginationList.children[2]);
                }
                // Agregar puntos suspensivos si hay páginas ocultas entre el rango deseado y la última página
                if (i === pagination.total_pages - 1 && paginationList.children[paginationList.children.length - 3].children[0].value + 1 !== pagination.total_pages) {
                  const ellipsis = document.createElement('li');
                  ellipsis.classList.add('page-item', 'disabled');
                  ellipsis.innerHTML = '<span>...</span>';
            
                  paginationList.insertBefore(ellipsis, paginationList.children[paginationList.children.length - 2]);
                }
              }
            }
          
            const nextLink = document.createElement('a');
            nextLink.classList.add('page-link');
            nextLink.setAttribute('href', '#');
            nextLink.setAttribute('aria-label', 'Next');
            nextLink.innerHTML = '<span aria-hidden="true">&raquo;</span>';
            nextLink.value = pagination.current_page + 1;
            nextLink.addEventListener('click', function() {
              sendPageRequest(nextLink.value);
            });
            
            const nextListItem = document.createElement('li');
            nextListItem.classList.add('page-item');
            nextListItem.appendChild(nextLink);
            
            paginationList.appendChild(nextListItem);
          }
          function sendPageRequest(pageValue) {
            let page = parseInt(pageValue);
            if (page < 1) {
              page = 1;
            } else if (page > parseInt(document.querySelector('.pagination').children[document.querySelector('.pagination').children.length - 2].children[0].value)) {
              page = parseInt(document.querySelector('.pagination').children[document.querySelector('.pagination').children.length - 2].children[0].value);
            }
          
            loadHistory(page);
          
            const prevLink = document.querySelector('.pagination li:first-child a');
            const nextLink = document.querySelector('.pagination li:last-child a');
            if (page === 1) {
              prevLink.classList.add('disabled');
            } else {
              prevLink.classList.remove('disabled');
            }
            if (page === parseInt(document.querySelector('.pagination').children[document.querySelector('.pagination').children.length - 2].children[0].value)) {
              nextLink.classList.add('disabled');
            } else {
              nextLink.classList.remove('disabled');
            }
          }
          
        cont = 0
        const menu = document.querySelector('#menu');
        function ocultarMenu() {
            if (cont == 0) {
                cont++
                menu.classList.add('nav-anime');
            } else {
                menu.classList.remove('nav-anime')
                cont = 0
            }
        }
    </script>

</html>